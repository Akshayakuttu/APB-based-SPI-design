

module shift_register (

    // Inputs
    input        miso,
    input        PRESETn,
    input        cpha,
    input        PCLK,
    input        ss,
    input        flag_low,
    input        flag_high,
    input        flags_low,
    input        flags_high,
    input        lsbfe,
    input        cpol,
    input        send_data,
    input        receive_data,
    input  [7:0] data_mosi,

    // Outputs
    output       mosi,
    output [7:0] data_miso
);

    // Shift-out and shift-in registers
    reg [7:0] shift_reg;
    reg [7:0] recv_reg;

    // Counters for bit extraction order
    reg [2:0] bit_counter_send;
    reg [2:0] bit_counter_recv;

    // MOSI output register
    reg mosi_reg;

    // Edge selection based on CPOL/CPHA
    wire shift_edge  = (cpol ^ cpha) ? flags_high : flags_low;
    wire sample_edge = (cpol ^ cpha) ? flag_high  : flag_low;

    assign mosi      = mosi_reg;
    assign data_miso = receive_data ? recv_reg : 8'h00;

    // Main shift logic
    always @(posedge PCLK or negedge PRESETn) begin
        if (!PRESETn) begin
            shift_reg        <= 8'b0;
            recv_reg         <= 8'b0;
            bit_counter_send <= 3'd0;
            bit_counter_recv <= 3'd0;
            mosi_reg         <= 1'b0;
        end
        else if (!ss) begin

            // Load outgoing data on send request
            if (send_data) begin
                shift_reg        <= data_mosi;
                bit_counter_send <= lsbfe ? 3'd0 : 3'd7;
                bit_counter_recv <= lsbfe ? 3'd7 : 3'd0;
            end

            // MOSI shift operation
            if (shift_edge) begin
                mosi_reg <= shift_reg[bit_counter_send];

                if (lsbfe)
                    bit_counter_send <= bit_counter_send + 1'b1;
                else
                    bit_counter_send <= bit_counter_send - 1'b1;
            end

            // MISO sampling operation
            if (sample_edge) begin
                recv_reg[bit_counter_recv] <= miso;

                if (lsbfe)
                    bit_counter_recv <= bit_counter_recv - 1'b1;
                else
                    bit_counter_recv <= bit_counter_recv + 1'b1;
            end
        end
        else begin
            // Reset counters when slave is inactive
            mosi_reg         <= 1'b0;
            bit_counter_send <= lsbfe ? 3'd0 : 3'd7;
            bit_counter_recv <= lsbfe ? 3'd7 : 3'd0;
        end
    end

endmodule